## 回答1

### 前提
次のようなユースケースの範囲で、チャットアプリのテーブル設計をしていきます。

[★] は、DBとのやりとりが必要となるステップです。

- ワークスペースを検索する
  - [★] フリーワードでワークスペース名が検索でき、合致するものとリスト表示する
  - 検索結果のワークスペース一覧には参加ボタンがある

- 会員登録
  - [★] メールアドレスを入力したら、重複を確認して認証メールが届く
  - [★] 認証メールが届いて、そのリンクを踏んだらメールアドレスでの会員登録が完了

- ワークスペースを作成する
  - ログアウト状態であれば、会員登録orログインを促いしてから再度表示する
  - ワークスペース情報を入力するページを表示する
  - ドメイン名（ワークスペース一意の自然キー）が重複していないか確認
  - 招待メンバーを追加する（スキップ可能）
  - [★] ワークスペースが作成される
  - 招待メンバーに認証メールを送る
  - [★] 招待メンバーが認証メールを踏むと、会員登録とワークスペース参加者に追加される

- ワークスペースに参加する
  - [★] ワークスペース情報が表示される
  - [★] 参加ボタンを押すと、ワークスペース参加ユーザーに追加する
  - 参加後はワークスペースのTOPページが表示される

- ワークスペース（TOPページ）を閲覧する
  - [★] ユーザーがワークスペース参加者であるかを照合する
  - [★] ユーザーが参加しているチャンネル一覧を取得して表示する
  - [★] 参加チャンネルの中で、選択されているチャンネルメッセージ内容を表示する

- チャンネルを作成する
  - チャンネル作成ボタンを押す
  - チャンネル名を入力する
  - チャンネルに招待するユーザを選択する
  - [★] チャンネルが作成される
  - [★] 招待された人がチャンネル参加ユーザーに追加される
  - [★] チャンネルに招待された旨のメッセージが追加される

- チャンネルに参加する
  - [★] チャンネル一覧が表示される
  - [★] 参加ボタンを押すと、チャンネル参加ユーザーに追加される

- チャンネルに招待する
  - 招待するユーザーを選択する
  - [★] 招待された人がチャンネル参加ユーザーに追加される
  - [★] チャンネルに招待された旨のメッセージが追加される

- メッセージを投稿する
  - メッセージを入力して送信する
  - [★] メッセージがDBに追加される
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上に新しくメッセージが追加される

- スレッドメッセージを投稿する
  - メッセージのスレッドに文章を入力して送信する
  - [★] スレッドメッセージがDBに反映される
  - [★] チャンネル参加ユーザーにスレッドメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上に新しくスレッドメッセージが追加される

- メッセージを削除する
  - メッセージを削除するボタンを押す
  - [★] メッセージのDBデータを削除ステータスに変更する
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上のメッセージを削除する

- メッセージを編集する
  - 編集後メッセージを入力して編集ボタンを押す
  - [★] メッセージのDBデータの内容を更新して、ステータスも編集済みステータスに変更する
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上のメッセージを編集する（メッセージには編集済みと表記）

- ワークスペースを脱退する
  - ワークスペースを脱退するボタンを押す
  - [★] チャンネル参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - [★] ワークスペース参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - ユーザープロフィールを見ると脱退済みと記載される

- チャンネルを脱退する
  - ワークスペースを脱退するボタンを押す
  - [★] チャンネル参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - ユーザープロフィールをみると脱退済みと記載される

- メッセージを検索する
  - ワークスペース内のフリーワードで検索をする
  - [★] そのワークスペースの参加チャンネルの中で、フリーワードを含むメッセージとスレッドメッセージを取得する
  - 取得した検索合致メッセージを表示する


---

### ER図
次のようなスキーマを考えました。


<img src="./images/db_modeling2_02.svg" style="width:2000px">


---

### ユースケース毎のクエリ

- ワークスペースを検索する
  - [★] フリーワードでワークスペース名が検索でき、合致するものとリスト表示する
  - 検索結果のワークスペース一覧には参加ボタンがある


フリーワードでワークスペース名が検索でき、合致するものとリスト表示する
```sql
SELECT
    w.id as workspace_id
    ,w.workspace_name as workspace_name
    ,w.domain_name as domain_name
FROM
    workspaces as w
    LEFT JOIN workspace_statuses as ws
    ON w.workspace_status_id = ws.id
WHERE
    ws.workspace_status = "表示"
    AND w.workspace_name LIKE "%keyword%"

```

---

- 会員登録
  - [★] メールアドレスを入力したら、重複を確認して認証メールが届く
  - [★] 認証メールが届いて、そのリンクを踏んだらメールアドレスでの会員登録が完了


会員登録にあたるメール重複ユーザーの確認
```sql
SELECT
    id
FROM
    users as u
WHERE
    u.mail == "user6@example.com"
```

会員登録
```sql
INSERT INTO users (mail) VALUES ("user6@example.com");
```

---

- ワークスペースを作成する
  - ログアウト状態であれば、会員登録orログインを促いしてから再度表示する
  - ワークスペース情報を入力するページを表示する
  - ドメイン名（ワークスペース一意の自然キー）が重複していないか確認
  - 招待メンバーを追加する（スキップ可能）
  - [★] ワークスペースが作成される
  - 招待メンバーに認証メールを送る
  - [★] 招待メンバーが認証メールを踏むと、会員登録とワークスペース参加者に追加される

ワークスペースが作成される
```sql
INSERT INTO workspaces
    (domain_name, workspace_name, workspace_status_id, user_id)
    VALUES ("confirm-usecases", "usecases", 1, 6);
```


招待メンバーが認証メールを踏むと、会員登録とワークスペース参加者に追加される

```sql
/* 会員登録 */
INSERT INTO users (mail) VALUES ("user7@example.com");

/* 招待者が認証メールを踏むと、ワークスペース参加者に追加 */
INSERT INTO users_workspaces
    (user_id, workspace_id, workspace_join_status_id)
    VALUES (7, 4, 1);
```

---

- ワークスペースに参加する
  - [★] ワークスペース情報が表示される
  - [★] 参加ボタンを押すと、ワークスペース参加ユーザーに追加される
  - 参加後はワークスペースのTOPページが表示される

ワークスペース情報が表示される

この時、表示ステータス（削除されていない）、かつユーザーが未参加のワークスペースの情報をリストで表示する。
```sql
SELECT
    w.id as workspace_id
    ,w.workspace_name as workspace_name
    ,w.domain_name as domain_name
    ,(CASE WHEN uw.workspace_join_status = "参加中" THEN 1 ELSE 0 END) as "参加ステータス"
FROM
    (
        SELECT
            tmp_w.id as id
        	,tmp_w.workspace_name as workspace_name
        	,tmp_w.domain_name as domain_name
        FROM
            workspaces as tmp_w
            LEFT JOIN workspace_statuses as tmp_ws
            ON tmp_w.workspace_status_id = tmp_ws.id
        WHERE
            tmp_ws.workspace_status = "表示"
    ) as w
    LEFT JOIN 
    (
        SELECT
        	tmp_uw.workspace_id as workspace_id
        	,tmp_wjs.workspace_join_status as workspace_join_status
       	FROM
        	users_workspaces as tmp_uw
            LEFT JOIN workspace_join_statuses as tmp_wjs
            ON tmp_uw.workspace_join_status_id = tmp_wjs.id
       	WHERE
        	tmp_uw.user_id = 1
    ) as uw
    ON w.id = uw.workspace_id
```


参加ボタンを押すと、ワークスペース参加ユーザーに追加される
```sql
INSERT INTO users_workspaces
    (user_id, workspace_id, workspace_join_status_id)
    VALUES (1, 1, 1);
```

---

- ワークスペース（TOPページ）を閲覧する
  - [★] ユーザーがワークスペース参加者であるかを照合する
  - [★] ユーザーが参加しているチャンネル一覧を取得して表示する
  - [★] 参加チャンネルの中で、選択されているチャンネルメッセージ内容を表示する

- チャンネルを作成する
  - チャンネル作成ボタンを押す
  - チャンネル名を入力する
  - チャンネルに招待するユーザを選択する
  - [★] チャンネルが作成される
  - [★] 招待された人がチャンネル参加ユーザーに追加される
  - [★] チャンネルに招待された旨のメッセージが追加される

- チャンネルに参加する
  - [★] チャンネル一覧が表示される
  - [★] 参加ボタンを押すと、チャンネル参加ユーザーに追加される

- チャンネルに招待する
  - 招待するユーザーを選択する
  - [★] 招待された人がチャンネル参加ユーザーに追加される
  - [★] チャンネルに招待された旨のメッセージが追加される

- メッセージを投稿する
  - メッセージを入力して送信する
  - [★] メッセージがDBに追加される
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上に新しくメッセージが追加される

- スレッドメッセージを投稿する
  - メッセージのスレッドに文章を入力して送信する
  - [★] スレッドメッセージがDBに反映される
  - [★] チャンネル参加ユーザーにスレッドメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上に新しくスレッドメッセージが追加される

- メッセージを削除する
  - メッセージを削除するボタンを押す
  - [★] メッセージのDBデータを削除ステータスに変更する
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上のメッセージを削除する

- メッセージを編集する
  - 編集後メッセージを入力して編集ボタンを押す
  - [★] メッセージのDBデータの内容を更新して、ステータスも編集済みステータスに変更する
  - [★] チャンネル参加ユーザーにメッセージ更新リクエストを送る
  - チャンネル参加者であればリクエストを反映し、UI上のメッセージを編集する（メッセージには編集済みと表記）

- ワークスペースを脱退する
  - ワークスペースを脱退するボタンを押す
  - [★] チャンネル参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - [★] ワークスペース参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - ユーザープロフィールを見ると脱退済みと記載される

- チャンネルを脱退する
  - ワークスペースを脱退するボタンを押す
  - [★] チャンネル参加者リストの該当ユーザーのステータスを脱退済み等に変更する
  - ユーザープロフィールをみると脱退済みと記載される

- メッセージを検索する
  - ワークスペース内のフリーワードで検索をする
  - [★] そのワークスペースの参加チャンネルの中で、フリーワードを含むメッセージとスレッドメッセージを取得する
  - 取得した検索合致メッセージを表示する