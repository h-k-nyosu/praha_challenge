# 課題1

## 「mailAddress」カラムには、特定のドメインを持ったメールアドレスしか登録できない（a@example.com, b@example.comなど）。Checkを使うべきでしょうか？

 - checkを使うべき。基本方針として、アプリケーション側とデータベース側でバリデーションを効かせたほうが良いと考えているため。アプリケーション側で考慮が漏れていて不適切なメールアドレスを許してしまっても、DB側でエラーが発生すればミスに気づくことができる。

```sql
CONSTRAINT email_check CHECK (right(email, 11) = 'example.com')
```

 - またcheck制約はトランザクション毎に発生するため、変更における影響範囲が小さくすむ。

## ユーザーが退会した時、当該ユーザーのレコードを「User」テーブルから削除し、同じ情報を「WithdrawnUser」テーブルに挿入しなければいけない。Triggerを使うべきでしょうか？

 - 時と場合によるが、基本的には使わない方が良いと考える。理由は保守性の観点にある。
   - ビジネスロジックがアプリケーションだけではなくデータベース側にも広がることで考慮すべき範囲が広がってしまうという点
   - 可視化されにくいデータベース側で「User」テーブルと「WithdrawnUser」テーブルが依存関係となることによって、考慮すべき仕様が複雑になってしまうという点


## 「gender」カラムには「male」「female」「no response」いずれかの値しか入れてはいけない。Enumを使うべきでしょうか？

 - 使うべきではないと考える。性別は上記3択以外にも増える可能性があり、必ず増えない保証がない限りEnumは避けるべきと考えている。
 - 理由は、Enumのvalidな値を変更する際にメタデータを変更する必要があり、データ量が膨大だと長時間のテーブルロックにつながる可能性があるため。


## 「postCode」カラムには特定形式の文字列しか入れてはいけない。Domainを使うべきでしょうか？

 - 世界規模で利用する見通しがないサービスであれば使っても良いと思う。郵便番号は日本標準となるので、日本の範囲においては基本的に形式に変更をする必要がない統一形式なのでDOMAINを使うメリットはあるかなと考える。

```sql
CREATE DOMAIN postal_code AS varchar(10) CHECK (value ~ E'^\\d{3}-\\d{4}$');

CREATE TABLE addresses (
    id serial primary key,
    postal_code postal_code NOT NULL,
    ...
);

```


## 上記のような制約をアプリケーション側で課すアプローチと、データベース側で制約を課すアプローチがあります。どちらをどのような時に採用するべきだと思いますか？

 - バリデーションに関しては、アプリケーション側とデータベース側どちらにも課した方が良いと考える。ただし制約の付け方に柔軟性を持たせるのであれば、アプリケーション側でも良いのかなとも思う（DB側に非常に限定的な制約をつけて、後から何度も改修が必要となってしまう場合は、保守範囲が広がって負荷が大きくなってしまうと考えるから）
 - ビジネスロジックに関わる部分（主にTrigger）に関しては、基本的にアプリケーション側で課すのが好ましそう。ただ短期間のみ利用されるサービスである＆少人数で開発を行う＆実装スピードが求められるなどがあれば、Triggerを採用する余地はあるかもしれない。

<br>

# 課題2

 - 請求管理などのBtoBサービスで、売上集計をしたいというときに、アプリケーション側によるバッチ処理での更新ではなく、triggerを使って更新しようというケースが起きそう（実装時は良いが、その後の運用保守でいろいろなトラブルを生みそう）
 - 例えばお寿司アプリの会計ステータス管理にEnumを使ったが、UberEatsなどのオンライン注文のステータスを後から追加したいというときに、改修コストが大きくなってしまいそう